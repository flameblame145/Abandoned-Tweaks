<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Abandoned Tweaks</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBM2hoB6SsSKywsbJoYkd8CWG1I46raBTY",
      authDomain: "abandonedtweaks-b47a2.firebaseapp.com",
      projectId: "abandonedtweaks-b47a2",
      storageBucket: "abandonedtweaks-b47a2.firebasestorage.app",
      messagingSenderId: "26177710755",
      appId: "1:26177710755:web:c804d0eef4be276a7c2d16",
      measurementId: "G-6H06DVYMCV"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    auth.onAuthStateChanged(async user => {
      const btn = document.getElementById('auth-btn');
      if (user) {
        btn.textContent = 'Logout';
        btn.onclick = () => auth.signOut().then(() => window.location.reload());

        // Check if user already has a code and show it
        const usedRef = db.collection('discountCodesUsed').doc(user.uid);
        const doc = await usedRef.get();
        if (doc.exists && doc.data().randomCode) {
          showCodePanel(doc.data().randomCode);
        }
      } else {
        btn.textContent = 'Login / Signup';
        btn.onclick = () => window.location.href = 'login.html';
        hideCodePanel();
      }
    });

    function generateRandomCode(length = 12) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let result = '';
      for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }

    async function enterDiscountCode() {
      const user = auth.currentUser;
      if (!user) {
        alert('You must be logged in to enter a discount code.');
        return;
      }

      const code = prompt('Enter your discount code:');
      if (!code) return;

      if (code !== 'TikTok15') {
        alert('Invalid discount code.');
        return;
      }

      const usedRef = db.collection('discountCodesUsed').doc(user.uid);
      const doc = await usedRef.get();

      if (doc.exists) {
        alert('You have already used this discount code once.');
        return;
      }

      const randomCode = generateRandomCode();
      const timestamp = new Date();

      await usedRef.set({
        codeUsed: code,
        randomCode,
        usedAt: timestamp.toISOString()
      });

      showCodePanel(randomCode);
    }

    function copyDiscountCode() {
      const text = document.getElementById('codeText').innerText.replace('Your code: ', '');
      navigator.clipboard.writeText(text).then(() => {
        alert('Code copied to clipboard!');
      }).catch(err => {
        console.error('Failed to copy code: ', err);
      });
    }

    function showCodePanel(code) {
      const panel = document.getElementById('codePanel');
      document.getElementById('codeText').innerText = `Your code: ${code}`;
      panel.style.display = 'block';
      setTimeout(() => panel.classList.add('visible'), 10); // trigger fade-in
    }

    function hideCodePanel() {
      const panel = document.getElementById('codePanel');
      panel.classList.remove('visible');
      setTimeout(() => panel.style.display = 'none', 300); // match fade-out
    }

    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('discountBtn').addEventListener('click', enterDiscountCode);
      document.getElementById('closeCodePanel').addEventListener('click', hideCodePanel);
    });
  </script>

  <style>
    /* Your existing styles remain unchanged ... */

    /* Floating code panel */
    #codePanel {
      position: fixed;
      bottom: 90px;
      right: 20px;
      background: rgba(0, 255, 255, 0.1);
      border: 2px solid #0ff;
      border-radius: 10px;
      padding: 1rem;
      color: #0ff;
      font-weight: bold;
      z-index: 1001;
      box-shadow: 0 0 15px #0ff;
      backdrop-filter: blur(6px);
      max-width: 250px;
      text-align: center;
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    #codePanel.visible {
      opacity: 1;
    }
    #codePanel button {
      margin-top: 0.5rem;
      padding: 0.3rem 0.8rem;
      background: #0ff;
      color: #111;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    #codePanel button:hover {
      background: #00ffff;
      box-shadow: 0 0 10px #00ffff;
    }
    #closeCodePanel {
      position: absolute;
      top: 4px;
      right: 6px;
      background: transparent;
      color: #0ff;
      border: none;
      font-size: 1rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <button id="auth-btn">Loading...</button>
  <div class="starry-background" id="stars"></div>

  <!-- Your existing content stays here (header, nav, products, etc.) -->

  <!-- Floating discount code panel -->
  <div id="codePanel">
    <button id="closeCodePanel">‚ùå</button>
    <p id="codeText">Your code: </p>
    <button onclick="copyDiscountCode()">Copy Code</button>
  </div>

  <button id="discountBtn">Enter Discount Code</button>

  <footer>
    &copy; 2025 Abandoned Tweaks. All rights reserved.
  </footer>

  <script>
    // Star background remains unchanged
    function createStar() {
      const star = document.createElement('div');
      star.classList.add('star');
      const sizes = ['small', 'medium', 'large'];
      star.classList.add(sizes[Math.floor(Math.random() * sizes.length)]);
      star.style.top = Math.random() * 100 + 'vh';
      star.style.left = Math.random() * 100 + 'vw';
      star.style.animationDelay = (Math.random() * 3) + 's';
      star.style.animationDuration = (3 + Math.random() * 3) + 's';
      document.getElementById('stars').appendChild(star);
    }
    for (let i = 0; i < 80; i++) createStar();

    function createShootingStar() {
      const shootingStar = document.createElement('div');
      shootingStar.classList.add('shooting-star');
      shootingStar.style.top = '0px';
      shootingStar.style.left = '0px';
      document.getElementById('stars').appendChild(shootingStar);
      setTimeout(() => shootingStar.remove(), 2000);
    }
    setInterval(createShootingStar, 10000);
  </script>
</body>
</html>
