<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Abandoned Tweaks</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

  <script>
    // Firebase config & initialization
    const firebaseConfig = {
      apiKey: "AIzaSyBM2hoB6SsSKywsbJoYkd8CWG1I46raBTY",
      authDomain: "abandonedtweaks-b47a2.firebaseapp.com",
      projectId: "abandonedtweaks-b47a2",
      storageBucket: "abandonedtweaks-b47a2.firebasestorage.app",
      messagingSenderId: "26177710755",
      appId: "1:26177710755:web:c804d0eef4be276a7c2d16",
      measurementId: "G-6H06DVYMCV"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Auth button handler
    auth.onAuthStateChanged(user => {
      const btn = document.getElementById('auth-btn');
      if (user) {
        btn.textContent = 'Logout';
        btn.onclick = () => auth.signOut().then(() => window.location.reload());
      } else {
        btn.textContent = 'Login / Signup';
        btn.onclick = () => window.location.href = 'login.html'; // Adjust if needed
      }
    });

    // Generate random code for discount order number
    function generateRandomCode(length = 12) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let result = '';
      for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }

    // Show discount panel with info
    function showDiscountPanel(randomCode, timestamp) {
      const existingPanel = document.getElementById('discountPanel');
      if (existingPanel) existingPanel.remove();

      const panel = document.createElement('div');
      panel.id = 'discountPanel';
      panel.innerHTML = `
        <button id="closeDiscountPanel" aria-label="Close discount info">&times;</button>
        <h2>Your Discount Code Number</h2>
        <div id="codeDisplay" style="font-weight:bold; font-size:1.5rem; margin: 0.5rem 0;">${randomCode}</div>
        <div id="usedAtDisplay">Used on: ${timestamp}</div>
        <div style="margin-top: 1rem; font-style: italic;">Enjoy your discount!</div>
      `;
      document.body.appendChild(panel);

      document.getElementById('closeDiscountPanel').onclick = () => {
        panel.remove();
      };
    }

    // Show error panel
    function showErrorPanel(message) {
      const existingPanel = document.getElementById('discountPanel');
      if (existingPanel) existingPanel.remove();

      const panel = document.createElement('div');
      panel.id = 'discountPanel';
      panel.innerHTML = `
        <button id="closeDiscountPanel" aria-label="Close error">&times;</button>
        <h2 style="color:#f55;">Error</h2>
        <div>${message}</div>
      `;
      document.body.appendChild(panel);

      document.getElementById('closeDiscountPanel').onclick = () => {
        panel.remove();
      };
    }

    // Check if user has used the discount before
    async function hasUsedDiscount(uid) {
      try {
        const docRef = db.collection('discountCodes').doc(uid);
        const doc = await docRef.get();
        return doc.exists; // if document exists, user used code before
      } catch (error) {
        console.error('Error checking discount code usage:', error);
        return false; // fail safe
      }
    }

    // Save discount usage to Firestore
    async function saveDiscountUsage(uid, randomCode, timestamp) {
      try {
        await db.collection('discountCodes').doc(uid).set({
          code: randomCode,
          usedAt: timestamp,
        });
      } catch (error) {
        console.error('Error saving discount code usage:', error);
      }
    }

    // Handle discount code entry flow
    async function handleDiscountCode() {
      const user = auth.currentUser;
      if (!user) {
        showErrorPanel('You must be logged in to use a discount code.');
        return;
      }

      const codeInput = prompt('Enter your discount code:');
      if (!codeInput) return;

      if (codeInput !== 'TikTok15') {
        showErrorPanel('Invalid discount code.');
        return;
      }

      const usedBefore = await hasUsedDiscount(user.uid);
      if (usedBefore) {
        showErrorPanel('You have already used this discount code.');
        return;
      }

      const randomCode = generateRandomCode();
      const now = new Date();
      const timestamp = now.toLocaleString();

      await saveDiscountUsage(user.uid, randomCode, timestamp);

      showDiscountPanel(randomCode, timestamp);
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('discountBtn').addEventListener('click', handleDiscountCode);
    });
  </script>

  <style>
    /* Base styles (same as before) */
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #f2f2f2;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    /* ... (all your other styles remain unchanged, including header, nav, products, starry background, buttons etc) */

    /* Discount button style */
    #discountBtn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      font-size: 1rem;
      font-weight: bold;
      background: #00ffff;
      border: none;
      border-radius: 8px;
      color: #111;
      cursor: pointer;
      box-shadow: 0 0 10px #00ffff;
      transition: box-shadow 0.3s;
      z-index: 1000;
    }
    #discountBtn:hover {
      box-shadow: 0 0 20px #00ffff;
    }

    /* Discount Panel Styles */
    #discountPanel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #111;
      border: 2px solid #0ff;
      box-shadow: 0 0 20px #0ff, 0 0 40px #0ff;
      padding: 2rem;
      color: #0ff;
      font-family: monospace;
      text-align: center;
      z-index: 2000;
      border-radius: 12px;
      min-width: 280px;
    }
    #discountPanel button#closeDiscountPanel {
      position: absolute;
      top: 8px;
      right: 12px;
      background: none;
      border: none;
      color: #0ff;
      font-size: 1.5rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <button id="auth-btn">Loading...</button>

  <!-- Starry background and site content here -->
  <header>
    <h1 class="title">Abandoned Tweaks</h1>
  </header>
  <nav>
    <a href="https://discord.gg/qyZEhex3HJ" target="_blank">Discord</a>
    <a href="#">Purchase</a>
    <a href="https://www.tiktok.com/@abandonedtweaks" target="_blank">TikTok</a>
  </nav>

  <div class="container">
    <div class="products">
      <!-- Your product cards go here as before -->
    </div>
  </div>

  <button id="discountBtn">Enter Discount Code</button>

  <footer>
    &copy; 2025 Abandoned Tweaks. All rights reserved.
  </footer>
</body>
</html>
