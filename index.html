<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Abandoned Tweaks</title>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBM2hoB6SsSKywsbJoYkd8CWG1I46raBTY",
  authDomain: "abandonedtweaks-b47a2.firebaseapp.com",
  projectId: "abandonedtweaks-b47a2",
  storageBucket: "abandonedtweaks-b47a2.appspot.com",
  messagingSenderId: "26177710755",
  appId: "1:26177710755:web:c804d0eef4be276a7c2d16",
  measurementId: "G-6H06DVYMCV"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Handle auth button
auth.onAuthStateChanged(user => {
  const btn = document.getElementById('auth-btn');
  if (user) {
    btn.textContent = 'Logout';
    btn.onclick = () => auth.signOut().then(() => window.location.reload());
  } else {
    btn.textContent = 'Login / Signup';
    btn.onclick = () => window.location.href = 'login.html';
  }
});

function generateRandomCode(length = 12) {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let result = '';
  for (let i = 0; i < length; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return result;
}

async function enterDiscountCode() {
  const user = auth.currentUser;
  if (!user) {
    alert('You must be logged in to see your discount code.');
    return;
  }

  const usedRef = db.collection('discountCodesUsed').doc(user.uid);
  const doc = await usedRef.get();

  if (doc.exists) {
    const data = doc.data();
    showDiscountPanel(data.randomCode, data.usedAt);
  } else {
    const code = prompt('Enter your discount code:');
    if (!code) return;
    if (code !== 'TikTok15') {
      alert('Invalid discount code.');
      return;
    }

    const randomCode = generateRandomCode();
    const timestamp = new Date().toISOString();

    await usedRef.set({ codeUsed: code, randomCode, usedAt: timestamp });
    showDiscountPanel(randomCode, timestamp);
  }
}

function showDiscountPanel(code, timestamp) {
  document.getElementById('savedCode').textContent = code;
  document.getElementById('savedDate').textContent = new Date(timestamp).toLocaleString();
  document.getElementById('discountPanel').style.display = 'block';
}

function closeDiscountPanel() {
  document.getElementById('discountPanel').style.display = 'none';
}

function copyDiscountCode() {
  const code = document.getElementById('savedCode').textContent;
  navigator.clipboard.writeText(code).then(() => alert('Code copied to clipboard!'));
}

window.addEventListener('DOMContentLoaded', () => {
  document.getElementById('discountBtn').addEventListener('click', enterDiscountCode);
});
</script>

<style>
/* Add your existing CSS here (kept for brevity) */
#discountPanel {
  display: none;
  position: fixed;
  top: 10%;
  left: 50%;
  transform: translateX(-50%);
  background: #222;
  color: #fff;
  padding: 1.5rem;
  border-radius: 8px;
  box-shadow: 0 0 20px #00ffff;
  z-index: 2000;
  width: 90%;
  max-width: 400px;
}
#discountPanel button {
  float: right;
  background: none;
  color: #fff;
  border: none;
  font-size: 1.2rem;
  cursor: pointer;
}
#savedCode {
  font-family: monospace;
  cursor: pointer;
}
</style>
</head>
<body>
<button id="auth-btn">Loading...</button>

<!-- Floating discount panel -->
<div id="discountPanel">
  <button onclick="closeDiscountPanel()">âœ–</button>
  <h3>Your Discount</h3>
  <p>Code: <span id="savedCode" onclick="copyDiscountCode()">Copy Me</span></p>
  <p>Entered on: <span id="savedDate"></span></p>
</div>

<button id="discountBtn">Enter Discount Code</button>

<!-- Keep your other HTML: header, nav, product cards, stars, etc -->
</body>
</html>
