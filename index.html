<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Abandoned Tweaks</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

  <style>
    /* Base styles */
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #f2f2f2;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    /* ... your existing styles unchanged ... */

    /* Discount button style */
    #discountBtn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      font-size: 1rem;
      font-weight: bold;
      background: #00ffff;
      border: none;
      border-radius: 8px;
      color: #111;
      cursor: pointer;
      box-shadow: 0 0 10px #00ffff;
      transition: box-shadow 0.3s;
      z-index: 1000;
    }
    #discountBtn:hover {
      box-shadow: 0 0 20px #00ffff;
    }

    /* Discount panel overlay */
    #discountPanelOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1500;
    }
    /* Panel container */
    #discountPanel {
      background: #e0f7f7;
      color: #111;
      border: 2px solid #00ffff;
      border-radius: 12px;
      padding: 2rem 2.5rem;
      max-width: 400px;
      width: 90%;
      position: relative;
      box-shadow: 0 0 20px #00ffff;
      font-family: Arial, sans-serif;
    }
    /* Close button */
    #discountPanelClose, #resultPanelClose {
      position: absolute;
      top: 10px;
      right: 10px;
      background: transparent;
      border: none;
      font-size: 1.5rem;
      font-weight: bold;
      cursor: pointer;
      color: #00bbbb;
      transition: color 0.3s;
    }
    #discountPanelClose:hover, #resultPanelClose:hover {
      color: #008888;
    }
    /* Input & buttons */
    #discountInput {
      width: 100%;
      padding: 0.6rem 0.8rem;
      font-size: 1rem;
      border: 1.5px solid #00bbbb;
      border-radius: 6px;
      margin-top: 1.2rem;
      box-sizing: border-box;
      outline: none;
      transition: border-color 0.3s;
    }
    #discountInput:focus {
      border-color: #009999;
    }
    #discountSubmitBtn {
      margin-top: 1.5rem;
      background: #00bbbb;
      border: none;
      color: #111;
      font-weight: bold;
      padding: 0.8rem 1.2rem;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 0 8px #00bbbb;
      transition: background 0.3s, box-shadow 0.3s;
    }
    #discountSubmitBtn:hover {
      background: #009999;
      box-shadow: 0 0 14px #009999;
    }

    /* Result panel */
    #resultPanel {
      background: #e0f7f7;
      color: #111;
      border: 2px solid #00ffff;
      border-radius: 12px;
      padding: 2rem 2.5rem;
      max-width: 400px;
      width: 90%;
      position: relative;
      box-shadow: 0 0 20px #00ffff;
      font-family: Arial, sans-serif;
      display: none;
    }
    #resultContent p {
      margin: 0.8rem 0;
      font-size: 1.1rem;
    }
  </style>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBM2hoB6SsSKywsbJoYkd8CWG1I46raBTY",
      authDomain: "abandonedtweaks-b47a2.firebaseapp.com",
      projectId: "abandonedtweaks-b47a2",
      storageBucket: "abandonedtweaks-b47a2.firebasestorage.app",
      messagingSenderId: "26177710755",
      appId: "1:26177710755:web:c804d0eef4be276a7c2d16",
      measurementId: "G-6H06DVYMCV"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Handle auth button
    auth.onAuthStateChanged(user => {
      const btn = document.getElementById('auth-btn');
      if (user) {
        btn.textContent = 'Logout';
        btn.onclick = () => auth.signOut().then(() => window.location.reload());
      } else {
        btn.textContent = 'Login / Signup';
        btn.onclick = () => window.location.href = 'login.html'; // Adjust if you have a login page
      }
    });

    // Generate random code helper
    function generateRandomCode(length = 12) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let result = '';
      for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }

    // Show discount panel
    function showDiscountPanel() {
      document.getElementById('discountPanelOverlay').style.display = 'flex';
      // Reset input and messages
      document.getElementById('discountInput').value = '';
      document.getElementById('discountError').textContent = '';
      document.getElementById('discountSubmitBtn').disabled = false;
    }

    // Hide discount panel
    function hideDiscountPanel() {
      document.getElementById('discountPanelOverlay').style.display = 'none';
      hideResultPanel();
    }

    // Show result panel
    function showResultPanel(contentHTML) {
      const resultPanel = document.getElementById('resultPanel');
      resultPanel.querySelector('#resultContent').innerHTML = contentHTML;
      resultPanel.style.display = 'block';
    }

    // Hide result panel
    function hideResultPanel() {
      const resultPanel = document.getElementById('resultPanel');
      resultPanel.style.display = 'none';
    }

    // Handle discount submit
    async function handleDiscountSubmit() {
      const user = auth.currentUser;
      if (!user) {
        alert('You must be logged in to enter a discount code.');
        hideDiscountPanel();
        return;
      }

      const codeEntered = document.getElementById('discountInput').value.trim();

      if (!codeEntered) {
        document.getElementById('discountError').textContent = 'Please enter a discount code.';
        return;
      }

      if (codeEntered !== 'TikTok15') {
        document.getElementById('discountError').textContent = 'Invalid discount code.';
        return;
      }

      // Disable submit to prevent multiple clicks
      document.getElementById('discountSubmitBtn').disabled = true;
      document.getElementById('discountError').textContent = '';

      const usedRef = db.collection('discountCodesUsed').doc(user.uid);
      const doc = await usedRef.get();

      if (doc.exists) {
        // User already used the code, show previous code and date/time
        const data = doc.data();
        const prevCode = data.randomCode;
        const prevDate = new Date(data.usedAt).toLocaleString();

        showResultPanel(`
          <h2>Discount Code Already Used</h2>
          <p><strong>Discount Order Number:</strong> ${prevCode}</p>
          <p><strong>Used On:</strong> ${prevDate}</p>
        `);
      } else {
        // Generate new random code and save with timestamp
        const randomCode = generateRandomCode();
        const timestamp = new Date();

        await usedRef.set({
          codeUsed: codeEntered,
          randomCode,
          usedAt: timestamp.toISOString()
        });

        showResultPanel(`
          <h2>Success!</h2>
          <p><strong>Your Unique Discount Order Number:</strong> ${randomCode}</p>
          <p><strong>Used On:</strong> ${timestamp.toLocaleString()}</p>
        `);
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('discountBtn').addEventListener('click', showDiscountPanel);
      document.getElementById('discountPanelClose').addEventListener('click', hideDiscountPanel);
      document.getElementById('resultPanelClose').addEventListener('click', hideDiscountPanel);
      document.getElementById('discountSubmitBtn').addEventListener('click', handleDiscountSubmit);
    });
  </script>
</head>
<body>
  <button id="auth-btn">Loading...</button>
  <div class="starry-background" id="stars"></div>

  <header>
    <h1 class="title">Abandoned Tweaks</h1>
  </header>
  <nav>
    <a href="https://discord.gg/qyZEhex3HJ" target="_blank">Discord</a>
    <a href="#">Purchase</a>
    <a href="https://www.tiktok.com/@abandonedtweaks" target="_blank">TikTok</a>
  </nav>

  <div class="container">
    <div class="products">
      <!-- your existing product cards unchanged -->
      <!-- ... -->
    </div>
  </div>

  <button id="discountBtn">Enter Discount Code</button>

  <!-- Discount panel overlay -->
  <div id="discountPanelOverlay" aria-modal="true" role="dialog" aria-labelledby="discountPanelTitle" aria-describedby="discountPanelDesc" tabindex="-1">
    <div id="discountPanel">
      <button id="discountPanelClose" aria-label="Close discount panel">&times;</button>
      <h2 id="discountPanelTitle">Enter Discount Code</h2>
      <p id="discountPanelDesc">Please enter your discount code below:</p>
      <input type="text" id="discountInput" placeholder="Enter discount code" autocomplete="off" />
      <div id="discountError" style="color:#bb0000; margin-top:0.5rem; min-height:1.2em;"></div>
      <button id="discountSubmitBtn">Submit</button>
    </div>

    <div id="resultPanel" role="alert" aria-live="assertive" aria-atomic="true">
      <button id="resultPanelClose" aria-label="Close result panel">&times;</button>
      <div id="resultContent"></div>
    </div>
  </div>

  <footer>
    &copy; 2025 Abandoned Tweaks. All rights reserved.
  </footer>

  <script>
    // Your existing starry background and shooting star scripts unchanged
    function createStar() {
      const star = document.createElement('div');
      star.classList.add('star');
      const sizeClasses = ['small', 'medium', 'large'];
      star.classList.add(sizeClasses[Math.floor(Math.random() * sizeClasses.length)]);
      star.style.top = Math.random() * 100 + 'vh';
      star.style.left = Math.random() * 100 + 'vw';
      star.style.animationDelay = (Math.random() * 3) + 's';
      star.style.animationDuration = (3 + Math.random() * 3) + 's';
      document.getElementById('stars').appendChild(star);
    }
    for(let i=0; i < 80; i++) createStar();

    function createShootingStar() {
      const shootingStar = document.createElement('div');
      shootingStar.classList.add('shooting-star');
      shootingStar.style.top = '0px';
      shootingStar.style.left = '0px';
      document.getElementById('stars').appendChild(shootingStar);
      setTimeout(() => shootingStar.remove(), 2000);
    }
    setInterval(createShootingStar, 10000);
  </script>
</body>
</html>
